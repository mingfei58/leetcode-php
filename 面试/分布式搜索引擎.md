## 书籍推荐

- **Elasticsearch**	权威指南
- 解密搜索引擎技术实战 罗刚著

## 问题

### 1.倒排索引的原理

> 为了按词快速定位抓取过来的文档，需要以词为基础建立全文索引，也叫倒排索引。

倒排索引是相对于正向索引而言的，首先用正向索引来存储每个文档对应的单词列表，然后再建立倒排索引，根据单词来索引文档编号。

倒排索引的结构存储在二进制格式的多个索引文件中，其中以tis为后缀的文件中包含了单词信息；以frq为后缀的文件记录单词的文档编号和这个单词在文档中出现了多少次；以prx为后缀的文件包含了单词出现的位置信息。

### 2.ElasticSearch分布式增删改查如何实现

> ElasticSearch是天然的分布式搜索引擎，文档被分区到不同的容器或分片中，它们位于一个或多个节点中，分区要确保均匀的落到各个节点中，分片需要冗余防止硬件故障导致数据丢失，对集群中的每个节点的请求都能路由到相应数据的节点中，无论是增加、删除节点，分片都可以无缝的扩展和迁移。
>
> 一个分片就是一个Lucene实例，它本身就是一个完整的搜索引擎，作为存储文档的容器，每个文档都属于一个单独的主分片，主分片的数量决定了索引能存储多少数据，复制分片只是分片的一个副本，它可以防止硬件故障导致的数据丢失，同时可以提供读请求，一旦索引创建后，主分片的数量就固定了，但是复制分片的数量可以随时调整。
>
> 主节点故障后，节点上的主分片和其他分片也会丢失，首先选取新的主节点，然后会在其对应的复制分片中选取新的主分片。
>
> 分档并不是随机分配到各个节点中的，而是通过路由器实现分配和定位，路由规则时根据文档id得到哈希值，然后对主分片的数量进行取余

假设有3个节点，6个分片（2个主分片 4个复制分片），我们给它们命名为node 1节点 R0 和 P1，node 2节点 R0 和 R1 ，node 3 节点 R1 和 P0 。

新建、索引和删除一个文档的必要步骤：

1. 客户端给 node 1 发送 新建、索引和删除请求；
2. 节点使用路由器确定文档位于分片 0 ，它转发请求到 node 3，因为主分片 P0 位于这个节点上；
3. node 3 在主分片上执行请求，如果成功，它转发请求到位于node 1和 node 2相应的 复制分片 R0。当所有的复制分片报告成功，node 3报告成功到请求的节点，请求的节点再报告给客户端。

检索一个文档的必要步骤：

1. 客户端给 node 1 发送检索请求；
2. 节点使用路由器确定文档位于分片0，分片0对应的复制分片位于有三个节点，此时，假设根据负载策略，选择了node 2；
3. node 2返回结果给请求节点 node 1，然后node 1再将结果返回给客户端。

批量新建、索引和删除一个文档的必要步骤：

1. 客户端给 node 1发送bulk请求；
2. node 1为每个分片构建批量请求，然后转发请求到对应的主分片上；
3. 主分片一个一个的按序操作，当一个执行完后，主分片转发请求到对应的复制分片，然后执行下一个操作。所有操作都执行完且完成复制报告给请求节点后，请求节点再构建响应并返回给客户端

批量检索一个文档的必要步骤：

1. 客户端给 node 1发送mget请求；
2. node 1为每个分片构建一个多数据的检索请求，然后转发这些请求到对应的主分片或复制分片上，当所有回复被接收时，node 1构建响应并返回给客户端

### 3.集群中的深度分页问题

>分布式系统中，排序结果的花费随着分页的深入而成倍增长，所以网络搜索引擎基本不会返回多余1000条分页的数据

假设有5个分片用于搜索

请求第1页时，每个分片产生自己最顶端的10个结果，然后返回给他们的请求节点，再对这所有的50个结果进行排序，选择最顶端的10个结果

请求第1000页时，每个分片都必须产生最顶端的10010个结果，然后返回给他们的请求节点，再对所有的50050个结果进行排序，返回10001至10010的结果集

### 4.如何避免ElasticSearch读写冲突

> **悲观并发控制**
>
> 假设冲突经常发生，为了解决冲突需要把访问区块化。如Innodb中的行锁，确保只有加锁的那个线程可以修改那个数据
>
> **乐观并发控制**
>
> 被ElasticSearch 使用，假设冲突不经常发生，也不区块化访问，如果在读写中数据发生了变化，更新操作将失败。

ElasticSearch为每个文档标记了一个`_version` 编号，_`_version` 保证所有的修改都被正确排序，在进行更新和删除文档时，请求中增加`_version`参数，他可以允许你的代码中增加乐观锁控制。

### 5.关于重建索引

虽然可以给索引添加新的类型，或给类型添加新的字段，但是不能添加新的分析器或修改已有的字段。

修改已存在数据最简单的办法就是重建索引：创建一个新配置好的索引，然后将所有的文档从旧的索引复制到新的上。